/*! jepun 2018-03-29 */
$(document).ready(function(){function a(a,c,d,e,f){var h={};h.url=jCom.urlPath("BackProductETF/GetProductEtfs"),h.reload=!0,h.QryStartDate=a,h.QryEndDate=c,h.QryType=d,h.QryStatus=e,h.ProductEtfNo=f,$.when(g.addSelect("ProductEtfNo",h)).then(function(){0===f?g.getCtrl("ProductEtfNo")[0].selectedIndex=0:g.getCtrl("ProductEtfNo")[0].selectedIndex=1,b(g.getCtrl("ProductEtfNo").val())})}function b(a){g.getCtrl("BtnIns2,BtnUpd2,BtnDel2,BtnUpd,BtnDel,BtnInsFile1,BtnInsFile2,BtnInsFile3,BtnDelFile1,BtnDelFile2,BtnDelFile3,InputFile_1,InputFile_2,InputFile_3,NextFlow,BtnFlow").addClass("hidden"),null!==a&&void 0!==a&&0!==a&&$.when(g.callDataBus("BackProductETF/GetProductEtf",{ProductEtfNo:a}).then(function(){c(a,0),e(a,0)}))}function c(a,b){$.when(g.addSelect("ProductEtfFile1",d(a,1)),g.addSelect("ProductEtfFile2",d(a,2)),g.addSelect("ProductEtfFile3",d(a,3))).then(function(){g.getCtrl("InputFile_1").val(""),g.getCtrl("InputFile_2").val(""),g.getCtrl("InputFile_3").val("")})}function d(a,b){var c={};return c.url=jCom.urlPath("BackProductETF/GetProductEtfFiles"),c.reload=!0,c.ProductEtfNo=a,c.fileKind=b,c}function e(a,b){var c={};c.url=jCom.urlPath("BackProductETF/GetProductEtfSupplys"),c.ProductEtfNo=a,c.SupplyNum=b,c.reload=!0,$.when(g.addSelect("ProductEtfSupply",c)).then(function(){0===b?g.getCtrl("ProductEtfSupply")[0].selectedIndex=0:g.getCtrl("ProductEtfSupply").val(b),f(g.getCtrl("ProductEtfNo").val(),g.getCtrl("ProductEtfSupply").val())})}function f(a,b){null!==a&&void 0!==a&&null!==b&&void 0!==b&&"0"!==b&&g.callDataBus("BackProductETF/GetProductEtfSupply",{ProductEtfNo:a,SupplyNum:b})}var g=$("#FormBackProductETF").comm();g.addHandler("Ini",function(b){jFun.client.isMobile?g.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,EstablishDate,P_Date").prop("type","date"):(g.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,EstablishDate,P_Date").prop("type","text").addClass("dpDate"),g.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,EstablishDate,P_Date").datepicker({dateFormat:"yy/mm/dd",firstDay:0,changeYear:!0,changeMonth:!0,yearRange:"1900:2030"})),g.addSelect("SupplyKind",jFun.getOptionsUrl("SupplyKind",1)),g.addSelect("RiskLv",jFun.getOptionsUrl("RiskLvKind",1)),g.addSelect("Kind",jFun.getOptionsUrl("EtfKind",1)),g.addSelect("QryType",jFun.getOptionsUrl("Type",1,"",!1)),$.when(g.addSelect("QryStatus",jFun.getOptionsUrl("Status",1,"",!1))).then(function(){g.getCtrl("QryStatus")[0].selectedIndex=1}),a(null,null,null,"99",0)}),g.addHandler("BtnIns",function(b){a(null,null,null,null,b.ProductEtfNo)}),g.addHandler("BtnUpd",function(b){a(null,null,null,null,g.getCtrl("ProductEtfNo").val())}),g.addHandler("BtnDel",function(b){a(null,null,null,null,0)}),g.addHandler("BtnInsSupply",function(a){e(g.getCtrl("ProductEtfNo").val(),a.SupplyNum)}),g.addHandler("BtnUpdSupply",function(a){e(g.getCtrl("ProductEtfNo").val(),a.SupplyNum)}),g.addHandler("BtnDelSupply",function(a){e(g.getCtrl("ProductEtfNo").val(),0)}),g.addHandler("DelFile",function(a){c(g.getCtrl("ProductEtfNo").val(),a.Key)}),g.addHandler("GetProductEtf",function(a){initButton(g,a.obj,"ProductEtfNo"),"-1"===g.getCtrl("ProductEtfNo").val()&&g.setVal("P_Point","")}),g.addHandler("GetProductEtfSupply",function(a){var b=$.parseJSON(a.obj);b.length>0&&$.when(g.formInject(b[0])).then(function(){"0"===g.getCtrl("ProductEtfSupply").val()&&g.getCtrl("BtnUpd2,BtnDel2").addClass("hidden")})}),g.addHandler("NextFlow",function(b){a(null,null,null,"99",0)}),g.getCtrl("ProductEtfNo").on("click",function(a){a.preventDefault();var c=$(this);b(c.val()),"-1"===c.val()&&(g.getCtrl("SupplyKind").val("-1"),g.getCtrl("SupplyName,Phone,Mail_Address").val(""))}),g.getCtrl("QryFlow").on("click",function(a){a.preventDefault(),GlbAppModal.openModal("歷史流程","BackFlowDetail",{Type:5,Rno:g.getCtrl("ProductEtfNo").val()})}),g.getCtrl("ProductEtfSupply").on("click",function(a){a.preventDefault();var b=$(this),c=g.getCtrl("ProductEtfNo").val();f(c,b.val())}),g.getCtrl("BtnIns").on("click",function(a){a.preventDefault(),g.valid()&&g.formXhrDataBus("BackProductETF/Ins")}),g.getCtrl("BtnUpd").on("click",function(a){a.preventDefault();var b=g.formBeforeJSON();g.callDataBus("BackProductETF/Upd",{model:g.formToJSON(b,!1),Oldmodel:g.formBeforeJSON()})}),g.getCtrl("BtnDel").on("click",function(a){a.preventDefault(),g.callDataBus("BackProductETF/Del",{ProductEtfNo:g.getCtrl("ProductEtfNo").val(),NextType:"0",NextStatus:"7",Note:"",LogSN:g.getCtrl("LogSN").val()})}),g.getCtrl("BtnQry").on("click",function(b){b.preventDefault();var c=g.getCtrl("QryStartDate").val(),d=g.getCtrl("QryEndDate").val(),e=g.getCtrl("QryType").val(),f=g.getCtrl("QryStatus").val();a(c,d,e,f,0),g.getCtrl("ProductEtfSupply").html("")}),g.getCtrl("BtnInsFile1,BtnInsFile2,BtnInsFile3").on("click",function(a){a.preventDefault();var b=$(this),d=b.getKeyVal(),e=g.getCtrl("InputFile_"+d).val();if(""===e)return void jCom.Alert("提醒","請選擇檔案!!");var f=g.getCtrl("ProductEtfNo").val();g.getCtrl("FileKind").val(g.getCtrl("InputFile_"+d).attr("name"));return null===f||void 0===f?void jCom.Alert("提醒","請選一筆ETF!!"):void g.formXhrDataBus("BackProductETF/Upload",function(){c(g.getCtrl("ProductEtfNo").val(),d)})}),g.getCtrl("BtnDelFile1,BtnDelFile2,BtnDelFile3").on("click",function(a){a.preventDefault();var b=$(this),c=b.getKeyVal(),d=g.getCtrl("ProductEtfFile"+c).val();return null===d||void 0===d?void jCom.Alert("提醒","請選一筆檔案!!"):(d=d.split("@@"),void g.callDataBus("BackProductETF/DelFile",{ProductEtfNo:d[0],Num:d[1],LogSN:d[2],FileKind:d[3]}))}),g.getCtrl("ProductEtfFile1,ProductEtfFile2,ProductEtfFile3").on("click",function(a){a.preventDefault();var b=$(this),c=b.val();if(null!==c){var d=c.split("@@"),e=$("#DefTargetForm").comm();e.formTarget("BackProductETF/Download","{'ProductEtfNo':'"+d[0]+"','Num':'"+d[1]+"','FileKind':'"+d[3]+"'}")}}),g.getCtrl("BtnIns2").on("click",function(a){a.preventDefault();var b=g.getCtrl("ProductEtfNo").val();return null===b||void 0===b?void jCom.Alert("提醒","請選一個ETF!!"):void g.callDataBus("BackProductETF/InsProductEtfSupply",g.formToJSON())}),g.getCtrl("BtnUpd2").on("click",function(a){a.preventDefault();var b=g.getCtrl("ProductEtfSupply").val();return null===b||void 0===b?void jCom.Alert("提醒","請選參與券商or流動量提供者!!"):void g.callDataBus("BackProductETF/UpdProductEtfSupply",{model:g.formToJSON(),SupplyNum:b})}),g.getCtrl("BtnDel2").on("click",function(a){a.preventDefault();var b=g.getCtrl("ProductEtfNo").val(),c=g.getCtrl("ProductEtfSupply").val();return null===b||void 0===b||null===c||void 0===c?void jCom.Alert("提醒","請選一個參與券商or流動量提供者 !!"):void g.callDataBus("BackProductETF/DelProductEtfSupply",{ProductEtfNo:b,SupplyNum:c,LogSN:g.getCtrl("LogSN").val()})}),g.getCtrl("BtnFlow").on("click",function(a){$(this);a.preventDefault();var b=g.getCtrl("ProductEtfFile1").val(),c=g.getCtrl("ProductEtfFile2").val(),d=g.getCtrl("ProductEtfFile3").val(),e=g.getCtrl("ProductEtfSupply").val();if(null===b||void 0===b)return void jCom.Alert("提醒","請選擇一筆投資月報!!");if(null===c||void 0===c)return void jCom.Alert("提醒","請選擇一筆簡式公開說明書!!");if(null===d||void 0===d)return void jCom.Alert("提醒","請選擇一筆公開說明書!!");if(null===e||void 0===e)return void jCom.Alert("提醒","請新增一筆參與卷商or流動量提供者!!");var f=g.getCtrl("NextFlow").val().split("@@"),h={};return h.ProductEtfNo=g.getCtrl("ProductEtfNo").val(),h.NextType=f[0],h.NextStatus=f[1],h.Note="",h.EndDate=g.getCtrl("EndDate").val(),h.LogSN=g.getCtrl("LogSN").val(),"1"===f[0]&&""===g.getCtrl("EndDate").val()?void jCom.Alert("提醒","下架日必須填"):void g.callDataBus("BackProductETF/NextFlow",h)})});