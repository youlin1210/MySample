/*! jepun 2018-03-29 */
$(document).ready(function(){function a(a,d,e,f,g){var h={};h.url=jCom.urlPath("BackMaster/GetMasterAllT0"),h.reload=!0,h.QryStartDate=a,h.QryEndDate=d,h.QryType=e,h.QryStatus=f,h.MasterNo=g,$.when(c.addSelect("MasterNo",h)).then(function(){""!==GlbEnv.args.upcoming&&(c.getCtrl("MasterNo").filterSelect("-1",!0),$("#"+GlbEnv.args.upcoming+"Count").html(c.getCtrl("MasterNo").find("option").length)),0===g?c.getCtrl("MasterNo")[0].selectedIndex=0:c.getCtrl("MasterNo")[0].selectedIndex=1,b(c.getCtrl("MasterNo").val())})}function b(a){c.getCtrl("BtnUpd,BtnDel,NextFlow,BtnFlow").addClass("hidden"),null!==a&&void 0!==a&&c.callDataBus("BackMaster/GetMasterT1",{MasterNo:a})}var c=$("#FormBackMaster").comm();c.addHandler("Ini",function(b){jFun.client.isMobile?c.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,RevisionDate").prop("type","date"):(c.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,RevisionDate").prop("type","text").addClass("dpDate"),c.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,RevisionDate").datepicker({dateFormat:"yy/mm/dd",firstDay:0,changeYear:!0,changeMonth:!0,yearRange:"1900:2030"})),$.when(c.addSelect("QryStatus",jFun.getOptionsUrl("Status",1,"",!1)),c.addSelect("QryType",jFun.getOptionsUrl("Type",1,"",!1))).then(function(){c.getCtrl("QryStatus")[0].selectedIndex=1,""!==GlbEnv.args.upcoming?(c.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)})}),c.addHandler("BtnIns",function(b){a(null,null,null,null,b.MasterNo)}),c.addHandler("BtnUpd",function(b){a(null,null,null,null,c.getCtrl("MasterNo").val())}),c.addHandler("BtnDel",function(b){a(null,null,null,null,0)}),c.addHandler("GetMasterT1",function(a){initButton(c,a.obj,"MasterNo")}),c.addHandler("NextFlow",function(b){""!==GlbEnv.args.upcoming?(c.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)}),c.getCtrl("MasterNo").on("click",function(a){a.preventDefault();var c=$(this);b(c.val())}),c.getCtrl("QryFlow").on("click",function(a){a.preventDefault(),GlbAppModal.openModal("歷史流程","BackFlowDetail",{Type:18,Rno:c.getCtrl("MasterNo").val()})}),c.getCtrl("BtnIns").on("click",function(a){a.preventDefault(),c.valid()&&c.formXhrDataBus("BackMaster/Ins")}),c.getCtrl("BtnUpd").on("click",function(a){a.preventDefault();var b=c.formBeforeJSON();c.callDataBus("BackMaster/Upd",{model:c.formToJSON(b,!1),Oldmodel:c.formBeforeJSON()})}),c.getCtrl("BtnDel").on("click",function(a){a.preventDefault(),c.callDataBus("BackMaster/Del",{MasterNo:c.getCtrl("MasterNo").val(),NextType:"0",NextStatus:"7",Note:"",LogSN:c.getCtrl("LogSN").val()})}),c.getCtrl("BtnQry").on("click",function(b){b.preventDefault();var d=c.getCtrl("QryStartDate").val(),e=c.getCtrl("QryEndDate").val(),f=c.getCtrl("QryType").val(),g=c.getCtrl("QryStatus").val();a(d,e,f,g,0)}),c.getCtrl("BtnFlow").on("click",function(a){$(this);a.preventDefault();var b=c.getCtrl("NextFlow").val().split("@@"),d={};return d.MasterNo=c.getCtrl("MasterNo").val(),d.NextType=b[0],d.NextStatus=b[1],d.Note="",d.EndDate=c.getCtrl("EndDate").val(),d.LogSN=c.getCtrl("LogSN").val(),"1"===b[0]&&""===c.getCtrl("EndDate").val()?void jCom.Alert("提醒","下架日必須填"):void c.callDataBus("BackMaster/NextFlow",d)})});