/*! jepun 2018-03-29 */
$(document).ready(function(){function a(a,c,d,f,g){var h={};h.url=jCom.urlPath("BackProductFund/GetProductFunds"),h.reload=!0,h.QryStartDate=a,h.QryEndDate=c,h.QryType=d,h.QryStatus=f,h.ProductFundNo=g,$.when(e.addSelect("ProductFundNo",h)).then(function(){""!==GlbEnv.args.upcoming&&(e.getCtrl("ProductFundNo").filterSelect("-1",!0),$("#"+GlbEnv.args.upcoming+"Count").html(e.getCtrl("ProductFundNo").find("option").length)),0===g?e.getCtrl("ProductFundNo")[0].selectedIndex=0:e.getCtrl("ProductFundNo")[0].selectedIndex=1,b(e.getCtrl("ProductFundNo").val())})}function b(a){e.getCtrl("BtnUpd,BtnDel,BtnCopy,BtnInsFile1,BtnInsFile2,BtnInsFile3,BtnDelFile1,BtnDelFile2,BtnDelFile3,InputFile_1,InputFile_2,InputFile_3,NextFlow,BtnFlow").addClass("hidden"),null!==a&&void 0!==a&&$.when(e.callDataBus("BackProductFund/GetProductFund",{ProductFundNo:a})).then(function(){c(a,0)})}function c(a,b){b>0?$.when(e.addSelect("ProductFundFile"+b,d(a,b))).then(function(){e.getCtrl("InputFile_"+b).val("")}):$.when(e.addSelect("ProductFundFile1",d(a,1)),e.addSelect("ProductFundFile2",d(a,2)),e.addSelect("ProductFundFile3",d(a,3))).then(function(){e.getCtrl("InputFile_1").val(""),e.getCtrl("InputFile_2").val(""),e.getCtrl("InputFile_3").val("")})}function d(a,b){var c={};return c.url=jCom.urlPath("BackProductFund/GetProductFundFiles"),c.reload=!0,c.ProductFundNo=a,c.fileKind=b,c}var e=$("#FormBackProductFund").comm();e.addHandler("Ini",function(b){jFun.client.isMobile?e.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,EstablishDate").prop("type","date"):(e.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,EstablishDate").prop("type","text").addClass("dpDate"),e.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,EstablishDate").datepicker({dateFormat:"yy/mm/dd",firstDay:0,changeYear:!0,changeMonth:!0,yearRange:"1900:2030"})),$.when(e.addSelect("QryStatus",jFun.getOptionsUrl("Status",1,"",!1)),e.addSelect("QryType",jFun.getOptionsUrl("Type",1,"",!1)),e.addSelect("RiskLv",jFun.getOptionsUrl("RiskLvKind",1)),e.addSelect("FundType",jFun.getOptionsUrl("FundKind",1)),e.addSelect("Fund",jFun.getProductFundOptionsT3())).then(function(){e.getCtrl("QryStatus")[0].selectedIndex=1,""!==GlbEnv.args.upcoming?(e.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)})}),e.addHandler("BtnCopy",function(b){a(null,null,null,null,b.ProductFundNo)}),e.addHandler("BtnIns",function(b){a(null,null,null,null,b.ProductFundNo)}),e.addHandler("BtnUpd",function(b){a(null,null,null,null,e.getCtrl("ProductFundNo").val())}),e.addHandler("BtnDel",function(b){a(null,null,null,null,0)}),e.addHandler("DelFile",function(a){c(e.getCtrl("ProductFundNo").val(),a.Key)}),e.addHandler("GetProductFund",function(a){""!==GlbEnv.args.upcoming?$.when(initButton(e,a.obj,"ProductFundNo")).then(function(){e.getCtrl("BtnCopy").hide()}):initButton(e,a.obj,"ProductFundNo")}),e.addHandler("NextFlow",function(b){""!==GlbEnv.args.upcoming?(e.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)}),e.getCtrl("ProductFundNo").on("click",function(a){a.preventDefault();var c=$(this);b(c.val())}),e.getCtrl("QryFlow").on("click",function(a){a.preventDefault(),GlbAppModal.openModal("歷史流程","BackFlowDetail",{Type:6,Rno:e.getCtrl("ProductFundNo").val()})}),e.getCtrl("BtnCopy").on("click",function(a){if(a.preventDefault(),e.valid()){var b=e.getCtrl("Fund").val(),c=b.split("@@")[0],d=b.split("@@")[1];e.getCtrl("CID").val(c),e.getCtrl("FID").val(d),e.formXhrDataBus("BackProductFund/Copy")}}),e.getCtrl("BtnIns").on("click",function(a){if(a.preventDefault(),e.valid()){var b=e.getCtrl("Fund").val(),c=b.split("@@")[0],d=b.split("@@")[1];e.getCtrl("CID").val(c),e.getCtrl("FID").val(d),e.formXhrDataBus("BackProductFund/Ins")}}),e.getCtrl("BtnUpd").on("click",function(a){a.preventDefault();var b=e.formBeforeJSON(),c=e.getCtrl("Fund").val(),d=c.split("@@")[0],f=c.split("@@")[1];e.getCtrl("CID").val(d),e.getCtrl("FID").val(f),e.callDataBus("BackProductFund/Upd",{model:e.formToJSON(b,!1),Oldmodel:e.formBeforeJSON()})}),e.getCtrl("BtnDel").on("click",function(a){a.preventDefault(),e.callDataBus("BackProductFund/Del",{ProductFundNo:e.getCtrl("ProductFundNo").val(),NextType:"0",NextStatus:"7",Note:"",LogSN:e.getCtrl("LogSN").val()})}),e.getCtrl("BtnQry").on("click",function(b){b.preventDefault();var c=e.getCtrl("QryStartDate").val(),d=e.getCtrl("QryEndDate").val(),f=e.getCtrl("QryType").val(),g=e.getCtrl("QryStatus").val();a(c,d,f,g,0)}),e.getCtrl("BtnInsFile1,BtnInsFile2,BtnInsFile3").on("click",function(a){a.preventDefault();var b=$(this),d=b.getKeyVal(),f=e.getCtrl("InputFile_"+d).val();if(""===f)return void jCom.Alert("提醒","請選擇檔案!!");var g=e.getCtrl("ProductFundNo").val();e.getCtrl("FileKind").val(e.getCtrl("InputFile_"+d).attr("name"));return null===g||void 0===g?void jCom.Alert("提醒","請選一筆共同基金!!"):void e.formXhrDataBus("BackProductFund/Upload",function(){c(e.getCtrl("ProductFundNo").val(),d)})}),e.getCtrl("BtnDelFile1,BtnDelFile2,BtnDelFile3").on("click",function(a){a.preventDefault();var b=$(this),c=b.getKeyVal(),d=e.getCtrl("ProductFundFile"+c).val();return null===d||void 0===d?void jCom.Alert("提醒","請選一筆檔案!!"):(d=d.split("@@"),void e.callDataBus("BackProductFund/DelFile",{ProductFundNo:d[0],Num:d[1],LogSN:d[2],FileKind:d[3]}))}),e.getCtrl("ProductFundFile1,ProductFundFile2,ProductFundFile3").on("click",function(a){a.preventDefault();var b=$(this),c=b.val();if(null!==c){var d=c.split("@@"),e=$("#DefTargetForm").comm();e.formTarget("BackProductFund/Download","{'ProductFundNo':'"+d[0]+"','Num':'"+d[1]+"','FileKind':'"+d[3]+"'}")}}),e.getCtrl("BtnFlow").on("click",function(a){$(this);a.preventDefault();var b=e.getCtrl("ProductFundFile1").val(),c=e.getCtrl("ProductFundFile2").val(),d=e.getCtrl("ProductFundFile3").val();if(null===b||void 0===b)return void jCom.Alert("提醒","請選擇一筆投資月報!!");if(null===c||void 0===c)return void jCom.Alert("提醒","請選擇一筆簡式公開說明書!!");if(null===d||void 0===d)return void jCom.Alert("提醒","請選擇一筆公開說明書!!");var f=e.getCtrl("NextFlow").val().split("@@"),g={};return g.ProductFundNo=e.getCtrl("ProductFundNo").val(),g.NextType=f[0],g.NextStatus=f[1],g.Note="",g.EndDate=e.getCtrl("EndDate").val(),g.LogSN=e.getCtrl("LogSN").val(),"1"===f[0]&&""===e.getCtrl("EndDate").val()?void jCom.Alert("提醒","下架日必須填"):void e.callDataBus("BackProductFund/NextFlow",g)})});