/*! jepun 2018-03-29 */
$(document).ready(function(){function a(a,c,d,e,g){var h={};h.url=jCom.urlPath("BackSales/GetSales2"),h.reload=!0,h.QryStartDate=a,h.QryEndDate=c,h.QryType=d,h.QryStatus=e,h.SalesNo=g,$.when(f.addSelect("SalesNo",h)).then(function(){""!==GlbEnv.args.upcoming&&(f.getCtrl("SalesNo").filterSelect("-1",!0),$("#"+GlbEnv.args.upcoming+"Count").html(f.getCtrl("SalesNo").find("option").length)),0===g?f.getCtrl("SalesNo")[0].selectedIndex=0:f.getCtrl("SalesNo")[0].selectedIndex=1,b(f.getCtrl("SalesNo").val())})}function b(a){f.getCtrl("BtnIns2,BtnUpd2,BtnDel2,BtnUpd,BtnDel,BtnInsFile,BtnDelFile,InputFile,NextFlow,BtnFlow").addClass("hidden"),null!==a&&void 0!==a&&(f.callDataBus("BackSales/GetSales",{SalesNo:a}),c(a,0))}function c(a,b){var c={};c.url=jCom.urlPath("BackSales/GetSalesPlaces"),c.SalesNo=a,c.Num=b,c.reload=!0,$.when(f.addSelect("SalesPlace",c)).then(function(){0===b?f.getCtrl("SalesPlace")[0].selectedIndex=0:f.getCtrl("SalesPlace").val(b),d(f.getCtrl("SalesNo").val(),f.getCtrl("SalesPlace").val())})}function d(a,b){null!==a&&void 0!==a&&null!==b&&void 0!==b&&f.callDataBus("BackSales/GetSalesPlace",{SalesNo:a,Num:b})}function e(a){$.when(f.addSelect("Mail_Code",jFun.getEcZipCodeUrl(2,a.MailCityCode))).then(function(){f.formInject(a)})}var f=$("#FormBackSales").comm();f.addHandler("Ini",function(b){jFun.client.isMobile?f.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").prop("type","date"):(f.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").prop("type","text").addClass("dpDate"),f.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").datepicker({dateFormat:"yy/mm/dd",firstDay:0,changeYear:!0,changeMonth:!0,yearRange:"1900:2030"})),$.when(f.addSelect("QryStatus",jFun.getOptionsUrl("Status",1,"",!1)),f.addSelect("QryType",jFun.getOptionsUrl("Type",1,"",!1)),f.addSelect("CNO",jFun.getOptionsUrl("CNO",1)),f.addSelect("MailCityCode",jFun.getEcZipCodeUrl("1"))).then(function(){f.getCtrl("QryStatus")[0].selectedIndex=1,""!==GlbEnv.args.upcoming?(f.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)})}),f.addHandler("BtnIns",function(b){a(null,null,null,null,b.SalesNo)}),f.addHandler("BtnUpd",function(b){a(null,null,null,null,f.getCtrl("SalesNo").val())}),f.addHandler("BtnDel",function(b){a(null,null,null,null,0)}),f.addHandler("BtnInsPlace",function(a){c(f.getCtrl("SalesNo").val(),a.Num)}),f.addHandler("BtnUpdPlace",function(a){c(f.getCtrl("SalesNo").val(),a.Num)}),f.addHandler("BtnDelPlace",function(a){c(f.getCtrl("SalesNo").val(),0)}),f.addHandler("GetSales",function(a){initButton(f,a.obj,"SalesNo")}),f.addHandler("GetSalesPlace",function(a){var b=$.parseJSON(a.obj);b.length>0&&$.when(f.formInject(b[0])).then(function(){e(b[0])})}),f.addHandler("NextFlow",function(b){""!==GlbEnv.args.upcoming?(f.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)}),f.getCtrl("SalesNo").on("click",function(a){a.preventDefault();var c=$(this);b(c.val()),"-1"===c.val()&&(f.getCtrl("MailCityCode").val("-1"),f.getCtrl("Mail_Code,Mail_Address,PlaceName").val(""))}),f.getCtrl("QryFlow").on("click",function(a){a.preventDefault(),GlbAppModal.openModal("歷史流程","BackFlowDetail",{Type:11,Rno:f.getCtrl("SalesNo").val()})}),f.getCtrl("SalesPlace").on("click",function(a){a.preventDefault();var b=$(this),c=f.getCtrl("SalesNo").val();d(c,b.val())}),f.getCtrl("BtnIns").on("click",function(a){a.preventDefault(),f.valid()&&f.callDataBus("BackSales/Ins",f.formToJSON())}),f.getCtrl("BtnUpd").on("click",function(a){a.preventDefault();var b=f.formBeforeJSON();f.callDataBus("BackSales/Upd",{model:f.formToJSON(b,!1),Oldmodel:f.formBeforeJSON()})}),f.getCtrl("BtnDel").on("click",function(a){a.preventDefault(),f.callDataBus("BackSales/Del",{SalesNo:f.getCtrl("SalesNo").val(),NextType:"0",NextStatus:"7",Note:"",LogSN:f.getCtrl("LogSN").val()})}),f.getCtrl("BtnQry").on("click",function(b){b.preventDefault();var c=f.getCtrl("QryStartDate").val(),d=f.getCtrl("QryEndDate").val(),e=f.getCtrl("QryType").val(),g=f.getCtrl("QryStatus").val();a(c,d,e,g,0),f.getCtrl("SalesPlace").html("")}),f.getCtrl("BtnIns2").on("click",function(a){a.preventDefault();var b=f.getCtrl("SalesNo").val();return null===b||void 0===b?void jCom.Alert("提醒","請選一個銷售通路!!"):null===f.getCtrl("PlaceName").val()||void 0===f.getCtrl("PlaceName").val()||""===f.getCtrl("PlaceName").val()?void jCom.Alert("提醒","請輸入有效的值"):void f.callDataBus("BackSales/InsSalesPlace",f.formToJSON())}),f.getCtrl("BtnUpd2").on("click",function(a){a.preventDefault();var b=f.getCtrl("SalesPlace").val();return null===b||void 0===b?void jCom.Alert("提醒","請選一個據點!!"):void f.callDataBus("BackSales/UpdSalesPlace",{model:f.formToJSON()})}),f.getCtrl("BtnDel2").on("click",function(a){a.preventDefault();var b=f.getCtrl("SalesNo").val(),c=f.getCtrl("SalesPlace").val();return null===b||void 0===b||null===c||void 0===c?void jCom.Alert("提醒","請選一個地方!!"):void f.callDataBus("BackSales/DelSalesPlace",{SalesNo:b,Num:c,LogSN:f.getCtrl("LogSN").val()})}),f.getCtrl("BtnFlow").on("click",function(a){$(this);a.preventDefault();var b=f.getCtrl("SalesPlace").val();if(null===b||void 0===b)return void jCom.Alert("提醒","請輸入一筆據點!!");var c=f.getCtrl("NextFlow").val().split("@@"),d={};return d.SalesNo=f.getCtrl("SalesNo").val(),d.NextType=c[0],d.NextStatus=c[1],d.Note="",d.EndDate=f.getCtrl("EndDate").val(),d.LogSN=f.getCtrl("LogSN").val(),"1"===c[0]&&""===f.getCtrl("EndDate").val()?void jCom.Alert("提醒","下架日必須填"):void f.callDataBus("BackSales/NextFlow",d)}),f.getCtrl("MailCityCode").on("change",function(){var a=$(this);f.addSelect("Mail_Code",jFun.getEcZipCodeUrl(2,a.val()))}),f.getCtrl("Mail_Address").on("change",function(){var a=$(this);a.val(jFun.toFullChar(a.val()))})});