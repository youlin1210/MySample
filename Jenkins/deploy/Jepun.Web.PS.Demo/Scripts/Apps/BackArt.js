/*! jepun 2018-03-29 */
$(document).ready(function(){function a(a,c,e,f,g){var h={};h.url=jCom.urlPath("BackArt/GetArts"),h.reload=!0,h.QryStartDate=a,h.QryEndDate=c,h.QryType=e,h.QryStatus=f,h.ArtNo=g,$.when(d.addSelect("ArtNo",h)).then(function(){""!==GlbEnv.args.upcoming&&(d.getCtrl("ArtNo").filterSelect("-1",!0),$("#"+GlbEnv.args.upcoming+"Count").html(d.getCtrl("ArtNo").find("option").length)),0===g?d.getCtrl("ArtNo")[0].selectedIndex=0:d.getCtrl("ArtNo")[0].selectedIndex=1,b(d.getCtrl("ArtNo").val())})}function b(a){d.getCtrl("BtnUpd,BtnDel,BtnInsFile,BtnDelFile,InputFile,NextFlow,BtnFlow").addClass("hidden"),null!==a&&void 0!==a&&(d.callDataBus("BackArt/GetArt",{ArtNo:a}),c(a))}function c(a){var b={};b.url=jCom.urlPath("BackArt/GetArtFiles"),b.reload=!0,b.ArtNo=a,d.addSelect("ArtFile",b),d.getCtrl("InputFile").val("")}var d=$("#FormBackArt").comm();d.addHandler("Ini",function(b){jFun.client.isMobile?d.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").prop("type","date"):(d.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").prop("type","text").addClass("dpDate"),d.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").datepicker({dateFormat:"yy/mm/dd",firstDay:0,changeYear:!0,changeMonth:!0,yearRange:"1900:2030"})),$.when(d.addSelect("QryStatus",jFun.getOptionsUrl("Status",1,"",!1)),d.addSelect("QryType",jFun.getOptionsUrl("Type",1,"",!1)),d.addSelect("ArtType",jFun.getOptionsUrl("ArtType",1)),d.addSelect("Remark",jFun.getOptionsUrl("CNO",1)),d.addSelect("Kind",jFun.getOptionsUrl("ArtKind",1))).then(function(){d.getCtrl("QryStatus")[0].selectedIndex=1,""!==GlbEnv.args.upcoming?(d.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)})}),d.addHandler("BtnIns",function(b){a(null,null,null,null,b.ArtNo)}),d.addHandler("BtnUpd",function(b){a(null,null,null,null,d.getCtrl("ArtNo").val())}),d.addHandler("BtnDel",function(b){a(null,null,null,null,0)}),d.addHandler("DelFile",function(a){c(d.getCtrl("ArtNo").val())}),d.addHandler("GetArt",function(a){var b="",c=$.parseJSON(a.obj);b="00000"===c[0].Kind?"FundKind":"ArtType",$.when(d.addSelect("ArtType",jFun.getOptionsUrl(b,1))).then(function(){$.when(initButton(d,a.obj,"ArtNo")).then(function(){"00000"===c[0].Kind?(d.setHtml("lbName","基金類型"),d.getCtrl("ArtKind00001").show()):(d.setHtml("lbName","文章類型"),d.getCtrl("ArtKind00001").hide())})})}),d.addHandler("NextFlow",function(b){""!==GlbEnv.args.upcoming?(d.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)}),d.getCtrl("Kind").on("change",function(){var a=$(this),b="";"00000"===a.val()?(d.setHtml("lbName","基金類型"),b="FundKind",$.when(d.addSelect("ArtType",jFun.getOptionsUrl(b,1))).then(function(){d.getCtrl("ArtKind00001").show(),d.getCtrl("Remark").val("-1")})):(d.setHtml("lbName","文章類型"),b="ArtType",$.when(d.addSelect("ArtType",jFun.getOptionsUrl(b,1))).then(function(){d.getCtrl("ArtKind00001").hide()}))}),d.getCtrl("ArtNo").on("click",function(a){a.preventDefault();var c=$(this);b(c.val())}),d.getCtrl("QryFlow").on("click",function(a){a.preventDefault(),GlbAppModal.openModal("歷史流程","BackFlowDetail",{Type:1,Rno:d.getCtrl("ArtNo").val()})}),d.getCtrl("BtnIns").on("click",function(a){a.preventDefault(),d.valid()&&d.formXhrDataBus("BackArt/Ins")}),d.getCtrl("BtnUpd").on("click",function(a){a.preventDefault();var b=d.formBeforeJSON();d.callDataBus("BackArt/Upd",{model:d.formToJSON(b,!1),Oldmodel:d.formBeforeJSON()})}),d.getCtrl("BtnDel").on("click",function(a){a.preventDefault(),d.callDataBus("BackArt/Del",{ArtNo:d.getCtrl("ArtNo").val(),NextType:"0",NextStatus:"7",Note:"",LogSN:d.getCtrl("LogSN").val()})}),d.getCtrl("BtnQry").on("click",function(b){b.preventDefault();var c=d.getCtrl("QryStartDate").val(),e=d.getCtrl("QryEndDate").val(),f=d.getCtrl("QryType").val(),g=d.getCtrl("QryStatus").val();a(c,e,f,g,0)}),d.getCtrl("BtnInsFile").on("click",function(a){a.preventDefault();var b=d.getCtrl("InputFile").val();if(""===b)return void jCom.Alert("提醒","請選擇檔案!!");var e=d.getCtrl("ArtNo").val();return null===e||void 0===e?void jCom.Alert("提醒","請選一筆投資好文!!"):void d.formXhrDataBus("BackArt/Upload",function(){c(d.getCtrl("ArtNo").val())})}),d.getCtrl("BtnDelFile").on("click",function(a){a.preventDefault();var b=d.getCtrl("ArtFile").val();return null===b||void 0===b?void jCom.Alert("提醒","請選一筆檔案!!"):(b=b.split("@@"),void d.callDataBus("BackArt/DelFile",{ArtNo:b[0],Num:b[1],LogSN:b[2]}))}),d.getCtrl("ArtFile").on("click",function(a){var b=$(this);a.preventDefault();var c=b.val();if(null!==c){var d=c.split("@@"),e=$("#DefTargetForm").comm();e.formTarget("BackArt/Download","{'ArtNo':'"+d[0]+"','Num':'"+d[1]+"'}")}}),d.getCtrl("BtnFlow").on("click",function(a){$(this);a.preventDefault();var b=d.getCtrl("ArtFile").val();if(null===b||void 0===b)return void jCom.Alert("提醒","請選一筆檔案!!");var c=d.getCtrl("NextFlow").val().split("@@"),e={};return e.ArtNo=d.getCtrl("ArtNo").val(),e.NextType=c[0],e.NextStatus=c[1],e.Note="",e.EndDate=d.getCtrl("EndDate").val(),e.LogSN=d.getCtrl("LogSN").val(),"1"===c[0]&&""===d.getCtrl("EndDate").val()?void jCom.Alert("提醒","下架日必須填"):void d.callDataBus("BackArt/NextFlow",e)})});