/*! jepun 2018-03-29 */
$(document).ready(function(){function a(a,c,e,f,g){var h={};h.url=jCom.urlPath("BackActivity/GetActivitys"),h.reload=!0,h.QryStartDate=a,h.QryEndDate=c,h.QryType=e,h.QryStatus=f,h.ActivityNo=g,$.when(d.addSelect("ActivityNo",h)).then(function(){""!==GlbEnv.args.upcoming&&(d.getCtrl("ActivityNo").filterSelect("-1",!0),$("#"+GlbEnv.args.upcoming+"Count").html(d.getCtrl("ActivityNo").find("option").length)),0===g?d.getCtrl("ActivityNo")[0].selectedIndex=0:d.getCtrl("ActivityNo")[0].selectedIndex=1,b(d.getCtrl("ActivityNo").val())})}function b(a){d.getCtrl("BtnUpd,BtnDel,BtnInsFile,BtnDelFile,InputFile,NextFlow,BtnFlow").addClass("hidden"),null!==a&&void 0!==a&&(d.callDataBus("BackActivity/GetActivity",{ActivityNo:a}),c(a))}function c(a){var b={};b.url=jCom.urlPath("BackActivity/GetActivityFiles"),b.reload=!0,b.ActivityNo=a,d.addSelect("ActivityFile",b),d.getCtrl("InputFile").val("")}var d=$("#FormBackActivity").comm();d.addHandler("Ini",function(b){jFun.client.isMobile?d.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").prop("type","date"):(d.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").prop("type","text").addClass("dpDate"),d.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").datepicker({dateFormat:"yy/mm/dd",firstDay:0,changeYear:!0,changeMonth:!0,yearRange:"1900:2030"})),d.addSelect("QryType",jFun.getOptionsUrl("Type",1,"",!1)),$.when(d.addSelect("QryStatus",jFun.getOptionsUrl("Status",1,"",!1))).then(function(){d.getCtrl("QryStatus")[0].selectedIndex=1}),""!==GlbEnv.args.upcoming?(d.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)}),d.addHandler("BtnIns",function(b){a(null,null,null,null,b.ActivityNo)}),d.addHandler("BtnUpd",function(b){a(null,null,null,null,d.getCtrl("ActivityNo").val())}),d.addHandler("BtnDel",function(b){a(null,null,null,null,0)}),d.addHandler("DelFile",function(a){c(d.getCtrl("ActivityNo").val())}),d.addHandler("GetActivity",function(a){initButton(d,a.obj,"ActivityNo")}),d.addHandler("NextFlow",function(b){""!==GlbEnv.args.upcoming?(d.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)}),d.getCtrl("ActivityNo").on("click",function(a){a.preventDefault();var c=$(this);b(c.val())}),d.getCtrl("QryFlow").on("click",function(a){a.preventDefault(),GlbAppModal.openModal("歷史流程","BackFlowDetail",{Type:3,Rno:d.getCtrl("ActivityNo").val()})}),d.getCtrl("BtnIns").on("click",function(a){a.preventDefault(),d.valid()&&d.formXhrDataBus("BackActivity/Ins")}),d.getCtrl("BtnUpd").on("click",function(a){if(a.preventDefault(),d.valid()){d.callDataBus("BackActivity/Upd",d.formToJSON())}}),d.getCtrl("BtnDel").on("click",function(a){a.preventDefault(),d.callDataBus("BackActivity/Del",{ActivityNo:d.getCtrl("ActivityNo").val(),NextType:"0",NextStatus:"7",Note:"",LogSN:d.getCtrl("LogSN").val()})}),d.getCtrl("BtnQry").on("click",function(b){b.preventDefault();var c=d.getCtrl("QryStartDate").val(),e=d.getCtrl("QryEndDate").val(),f=d.getCtrl("QryType").val(),g=d.getCtrl("QryStatus").val();a(c,e,f,g,0)}),d.getCtrl("BtnInsFile").on("click",function(a){a.preventDefault();var b=d.getCtrl("InputFile").val();if(""===b)return void jCom.Alert("提醒","請選擇檔案!!");var e=d.getCtrl("ActivityNo").val();return null===e||void 0===e?void jCom.Alert("提醒","請選一筆活動項目!!"):void d.formXhrDataBus("BackActivity/Upload",function(){c(d.getCtrl("ActivityNo").val())})}),d.getCtrl("BtnDelFile").on("click",function(a){a.preventDefault();var b=d.getCtrl("ActivityFile").val();return null===b||void 0===b?void jCom.Alert("提醒","請選一筆檔案!!"):(b=b.split("@@"),void d.callDataBus("BackActivity/DelFile",{ActivityNo:b[0],Num:b[1],LogSN:b[2]}))}),d.getCtrl("ActivityFile").on("click",function(a){var b=$(this);a.preventDefault();var c=b.val();if(null!==c){var d=c.split("@@"),e=$("#DefTargetForm").comm();e.formTarget("BackActivity/Download","{'ActivityNo':'"+d[0]+"','Num':'"+d[1]+"'}")}}),d.getCtrl("BtnFlow").on("click",function(a){$(this);a.preventDefault();var b=d.getCtrl("ActivityFile").val();if(null===b||void 0===b)return void jCom.Alert("提醒","請選一張圖片!!");var c=d.getCtrl("NextFlow").val().split("@@"),e={};return e.ActivityNo=d.getCtrl("ActivityNo").val(),e.NextType=c[0],e.NextStatus=c[1],e.Note="",e.EndDate=d.getCtrl("EndDate").val(),e.LogSN=d.getCtrl("LogSN").val(),"1"===c[0]&&""===d.getCtrl("EndDate").val()?void jCom.Alert("提醒","下架日必須填"):void d.callDataBus("BackActivity/NextFlow",e)})});