/*! jepun 2018-03-29 */
$(document).ready(function(){function a(a,c,e){var f={};f.url=jCom.urlPath("BackBanner/GetBanners"),f.reload=!0,f.QryType=a,f.QryStatus=c,f.BannerNo=e,$.when(d.addSelect("BannerNo",f)).then(function(){""!==GlbEnv.args.upcoming&&(d.getCtrl("BannerNo").filterSelect("-1",!0),$("#"+GlbEnv.args.upcoming+"Count").html(d.getCtrl("BannerNo").find("option").length)),0===e?d.getCtrl("BannerNo")[0].selectedIndex=0:d.getCtrl("BannerNo")[0].selectedIndex=1,b(d.getCtrl("BannerNo").val())})}function b(a){d.getCtrl("BtnUpd,BtnDel,BtnInsFile,BtnDelFile,InputFile,NextFlow,BtnFlow").addClass("hidden"),null!==a&&void 0!==a&&(d.callDataBus("BackBanner/GetBanner",{BannerNo:a}),c(a))}function c(a){var b={};b.url=jCom.urlPath("BackBanner/GetBannerFiles"),b.reload=!0,b.BannerNo=a,d.addSelect("BannerFile",b),d.getCtrl("InputFile").val("")}var d=$("#FormBackBanner").comm();d.addHandler("Ini",function(b){jFun.client.isMobile?d.getCtrl("StartDate,EndDate").prop("type","date"):(d.getCtrl("StartDate,EndDate").prop("type","text").addClass("dpDate"),d.getCtrl("StartDate,EndDate").datepicker({dateFormat:"yy/mm/dd",firstDay:0,changeYear:!0,changeMonth:!0,yearRange:"1900:2030"})),$.when(d.addSelect("QryStatus",jFun.getOptionsUrl("Status",1,"",!1)),d.addSelect("QryType",jFun.getOptionsUrl("Type",1,"",!1))).then(function(){d.getCtrl("QryStatus")[0].selectedIndex=1,""!==GlbEnv.args.upcoming?(d.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,"1",0):a(null,"2",0)):a(null,"99",0)})}),d.addHandler("BtnIns",function(b){a(null,null,b.BannerNo)}),d.addHandler("BtnUpd",function(b){a(null,null,d.getCtrl("BannerNo").val())}),d.addHandler("BtnDel",function(b){a(null,null,0)}),d.addHandler("DelFile",function(a){c(d.getCtrl("BannerNo").val())}),d.addHandler("GetBanner",function(a){$.when(initButton(d,a.obj,"BannerNo")).then(function(){"-1"===d.getCtrl("BannerNo").val()&&d.setVal("Sort","")})}),d.addHandler("NextFlow",function(b){""!==GlbEnv.args.upcoming?(d.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,"1",0):a(null,"2",0)):a(null,"99",0)}),d.getCtrl("BannerNo").on("click",function(a){a.preventDefault();var c=$(this);b(c.val())}),d.getCtrl("QryFlow").on("click",function(a){a.preventDefault(),GlbAppModal.openModal("歷史流程","BackFlowDetail",{Type:4,Rno:d.getCtrl("BannerNo").val()})}),d.getCtrl("BtnIns").on("click",function(a){a.preventDefault(),d.valid()&&d.formXhrDataBus("BackBanner/Ins")}),d.getCtrl("BtnUpd").on("click",function(a){a.preventDefault();var b=d.formBeforeJSON();d.callDataBus("BackBanner/Upd",{model:d.formToJSON(b,!1),Oldmodel:d.formBeforeJSON()})}),d.getCtrl("BtnDel").on("click",function(a){a.preventDefault(),d.callDataBus("BackBanner/Del",{BannerNo:d.getCtrl("BannerNo").val(),NextType:"0",NextStatus:"7",Note:"",LogSN:d.getCtrl("LogSN").val()})}),d.getCtrl("BtnQry").on("click",function(b){b.preventDefault();var c=d.getCtrl("QryType").val(),e=d.getCtrl("QryStatus").val();a(c,e,0)}),d.getCtrl("BtnInsFile").on("click",function(a){a.preventDefault();var b=($(this),d.getCtrl("InputFile").val());if(""===b)return void jCom.Alert("提醒","請選擇檔案!!");var e=d.getCtrl("BannerNo").val();return null===e||void 0===e?void jCom.Alert("提醒","請先選擇標題!!"):void d.formXhrDataBus("BackBanner/Upload",function(){c(d.getCtrl("BannerNo").val())})}),d.getCtrl("BtnDelFile").on("click",function(a){a.preventDefault();var b=d.getCtrl("BannerFile").val();return null===b||void 0===b?void jCom.Alert("提醒","請選一筆檔案!!"):(b=b.split("@@"),void d.callDataBus("BackBanner/DelFile",{BannerNo:b[0],Num:b[1],LogSN:b[2]}))}),d.getCtrl("BannerFile").on("click",function(a){a.preventDefault();var b=$(this),c=b.val();if(null!==c){var d=c.split("@@"),e=$("#DefTargetForm").comm();e.formTarget("BackBanner/Download","{'BannerNo':'"+d[0]+"','Num':'"+d[1]+"'}")}}),d.getCtrl("BtnFlow").on("click",function(a){$(this);a.preventDefault();var b=d.getCtrl("BannerFile").val();if(null===b||void 0===b)return void jCom.Alert("提醒","請選一張圖片!!");var c=d.getCtrl("NextFlow").val().split("@@"),e={};return e.BannerNo=d.getCtrl("BannerNo").val(),e.NextType=c[0],e.NextStatus=c[1],e.Note="",e.EndDate=d.getCtrl("EndDate").val(),e.LogSN=d.getCtrl("LogSN").val(),"1"===c[0]&&""===d.getCtrl("EndDate").val()?void jCom.Alert("提醒","下架日必須填"):void d.callDataBus("BackBanner/NextFlow",e)})});