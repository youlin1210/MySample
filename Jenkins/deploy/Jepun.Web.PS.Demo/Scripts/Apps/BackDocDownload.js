/*! jepun 2018-03-29 */
$(document).ready(function(){function a(a,c,e,f,g){var h={};h.url=jCom.urlPath("BackDocDownload/GetDocDownloads"),h.reload=!0,h.QryStartDate=a,h.QryEndDate=c,h.QryType=e,h.QryStatus=f,h.DocNo=g,$.when(d.addSelect("DocNo",h)).then(function(){""!==GlbEnv.args.upcoming&&(d.getCtrl("DocNo").filterSelect("-1",!0),$("#"+GlbEnv.args.upcoming+"Count").html(d.getCtrl("DocNo").find("option").length)),0===g?d.getCtrl("DocNo")[0].selectedIndex=0:d.getCtrl("DocNo")[0].selectedIndex=1,b(d.getCtrl("DocNo").val())})}function b(a){d.getCtrl("BtnUpd,BtnDel,BtnInsFile,BtnDelFile,InputFile,NextFlow,BtnFlow").addClass("hidden"),null!==a&&void 0!==a&&(d.callDataBus("BackDocDownload/GetDocDownload",{DocNo:a}),c(a))}function c(a){var b={};b.url=jCom.urlPath("BackDocDownload/GetDocDownloadFiles"),b.reload=!0,b.DocNo=a,d.addSelect("DocDownloadFile",b),d.getCtrl("InputFile").val("")}var d=$("#FormBackDocDownload").comm();d.addHandler("Ini",function(b){jFun.client.isMobile?d.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").prop("type","date"):(d.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").prop("type","text").addClass("dpDate"),d.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate").datepicker({dateFormat:"yy/mm/dd",firstDay:0,changeYear:!0,changeMonth:!0,yearRange:"1900:2030"})),$.when(d.addSelect("QryStatus",jFun.getOptionsUrl("Status",1,"",!1)),d.addSelect("QryType",jFun.getOptionsUrl("Type",1,"",!1)),d.addSelect("Kind",jFun.getOptionsUrl("DocKind",1))).then(function(){d.getCtrl("QryStatus")[0].selectedIndex=1,""!==GlbEnv.args.upcoming?(d.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)})}),d.addHandler("BtnIns",function(b){a(null,null,null,null,b.DocNo)}),d.addHandler("BtnUpd",function(b){a(null,null,null,null,d.getCtrl("DocNo").val())}),d.addHandler("BtnDel",function(b){a(null,null,null,null,0)}),d.addHandler("DelFile",function(a){c(d.getCtrl("DocNo").val())}),d.addHandler("GetDocDownload",function(a){initButton(d,a.obj,"DocNo")}),d.addHandler("NextFlow",function(b){""!==GlbEnv.args.upcoming?(d.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)}),d.getCtrl("DocNo").on("click",function(a){a.preventDefault();var c=$(this);b(c.val())}),d.getCtrl("QryFlow").on("click",function(a){a.preventDefault(),GlbAppModal.openModal("歷史流程","BackFlowDetail",{Type:10,Rno:d.getCtrl("DocNo").val()})}),d.getCtrl("BtnIns").on("click",function(a){a.preventDefault(),d.valid()&&d.formXhrDataBus("BackDocDownload/Ins")}),d.getCtrl("BtnUpd").on("click",function(a){a.preventDefault();var b=d.formBeforeJSON();d.callDataBus("BackDocDownload/Upd",{model:d.formToJSON(b,!1),Oldmodel:d.formBeforeJSON()})}),d.getCtrl("BtnDel").on("click",function(a){a.preventDefault(),d.callDataBus("BackDocDownload/Del",{DocNo:d.getCtrl("DocNo").val(),NextType:"0",NextStatus:"7",Note:"",LogSN:d.getCtrl("LogSN").val()})}),d.getCtrl("BtnQry").on("click",function(b){b.preventDefault();var c=d.getCtrl("QryStartDate").val(),e=d.getCtrl("QryEndDate").val(),f=d.getCtrl("QryType").val(),g=d.getCtrl("QryStatus").val();a(c,e,f,g,0)}),d.getCtrl("BtnInsFile").on("click",function(a){a.preventDefault();var b=d.getCtrl("InputFile").val();if(""===b)return void jCom.Alert("提醒","請選擇檔案!!");var e=d.getCtrl("DocNo").val();return null===e||void 0===e?void jCom.Alert("提醒","請選一筆表單!!"):void d.formXhrDataBus("BackDocDownload/Upload",function(){c(d.getCtrl("DocNo").val())})}),d.getCtrl("BtnDelFile").on("click",function(a){a.preventDefault();var b=d.getCtrl("DocDownloadFile").val();return null===b||void 0===b?void jCom.Alert("提醒","請選一筆檔案!!"):(b=b.split("@@"),void d.callDataBus("BackDocDownload/DelFile",{DocNo:b[0],Num:b[1],LogSN:b[2]}))}),d.getCtrl("DocDownloadFile").on("click",function(a){var b=$(this);a.preventDefault();var c=b.val();if(null!==c){var d=c.split("@@"),e=$("#DefTargetForm").comm();e.formTarget("BackDocDownload/Download","{'DocNo':'"+d[0]+"','Num':'"+d[1]+"'}")}}),d.getCtrl("BtnFlow").on("click",function(a){$(this);a.preventDefault();var b=d.getCtrl("DocDownloadFile").val();if(null===b||void 0===b)return void jCom.Alert("提醒","請選一筆檔案!!");var c=d.getCtrl("NextFlow").val().split("@@"),e={};return e.DocNo=d.getCtrl("DocNo").val(),e.NextType=c[0],e.NextStatus=c[1],e.Note="",e.EndDate=d.getCtrl("EndDate").val(),e.LogSN=d.getCtrl("LogSN").val(),"1"===c[0]&&""===d.getCtrl("EndDate").val()?void jCom.Alert("提醒","下架日必須填"):void d.callDataBus("BackDocDownload/NextFlow",e)})});