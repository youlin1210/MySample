/*! jepun 2018-03-29 */
$(document).ready(function(){function a(a,c,d,f,g){var h={};h.url=jCom.urlPath("BackProductOutSide/GetProductOutSides"),h.reload=!0,h.QryStartDate=a,h.QryEndDate=c,h.QryType=d,h.QryStatus=f,h.ProductOutSideNo=g,$.when(e.addSelect("ProductOutSideNo",h)).then(function(){""!==GlbEnv.args.upcoming&&(e.getCtrl("ProductOutSideNo").filterSelect("-1",!0),$("#"+GlbEnv.args.upcoming+"Count").html(e.getCtrl("ProductOutSideNo").find("option").length)),0===g?e.getCtrl("ProductOutSideNo")[0].selectedIndex=0:e.getCtrl("ProductOutSideNo")[0].selectedIndex=1,b(e.getCtrl("ProductOutSideNo").val())})}function b(a){e.getCtrl("BtnUpd,BtnDel,BtnCopy,BtnInsFile1,BtnInsFile2,BtnInsFile3,BtnInsFile4,BtnInsFile5,BtnDelFile1,BtnDelFile2,BtnDelFile3,BtnDelFile4,BtnDelFile5,InputFile_1,InputFile_2,InputFile_3,InputFile_4,InputFile_5,NextFlow,BtnFlow").addClass("hidden"),null!==a&&void 0!==a&&$.when(e.callDataBus("BackProductOutSide/GetProductOutSide",{ProductOutSideNo:a})).then(function(){c(a,0)})}function c(a,b){b>0?$.when(e.addSelect("ProductOutSideFile"+b,d(a,b))).then(function(){e.getCtrl("InputFile_"+b).val("")}):$.when(e.addSelect("ProductOutSideFile1",d(a,1)),e.addSelect("ProductOutSideFile2",d(a,2)),e.addSelect("ProductOutSideFile3",d(a,3)),e.addSelect("ProductOutSideFile4",d(a,4)),e.addSelect("ProductOutSideFile5",d(a,5))).then(function(){e.getCtrl("InputFile_1").val(""),e.getCtrl("InputFile_2").val(""),e.getCtrl("InputFile_3").val(""),e.getCtrl("InputFile_4").val(""),e.getCtrl("InputFile_5").val("")})}function d(a,b){var c={};return c.url=jCom.urlPath("BackProductOutSide/GetProductOutSideFiles"),c.reload=!0,c.ProductOutSideNo=a,c.fileKind=b,c}var e=$("#FormBackProductOutSide").comm();e.addHandler("Ini",function(b){jFun.client.isMobile?e.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,EstablishDate").prop("type","date"):(e.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,EstablishDate").prop("type","text").addClass("dpDate"),e.getCtrl("StartDate,EndDate,QryStartDate,QryEndDate,EstablishDate").datepicker({dateFormat:"yy/mm/dd",firstDay:0,changeYear:!0,changeMonth:!0,yearRange:"1900:2030"})),$.when(e.addSelect("QryStatus",jFun.getOptionsUrl("Status",1,"",!1)),e.addSelect("RiskLv",jFun.getOptionsUrl("RiskLvKind",1)),e.addSelect("AID",jFun.getProductOutSideOptionsT3()),e.addSelect("FundType",jFun.getOptionsUrl("OutSideKind",1)),e.addSelect("QryType",jFun.getOptionsUrl("Type",1,"",!1))).then(function(){e.getCtrl("QryStatus")[0].selectedIndex=1,""!==GlbEnv.args.upcoming?(e.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)})}),e.addHandler("BtnCopy",function(b){a(null,null,null,null,b.ProductOutSideNo)}),e.addHandler("BtnIns",function(b){a(null,null,null,null,b.ProductOutSideNo)}),e.addHandler("BtnUpd",function(b){a(null,null,null,null,e.getCtrl("ProductOutSideNo").val())}),e.addHandler("BtnDel",function(b){a(null,null,null,null,0)}),e.addHandler("DelFile",function(a){c(e.getCtrl("ProductOutSideNo").val(),a.Key)}),e.addHandler("GetProductOutSide",function(a){var b=$.parseJSON(a.obj);""!==GlbEnv.args.upcoming?$.when(e.addSelect("Fund",jFun.getProductOutSideOptionsT4(b[0].AID))).then(function(){$.when(initButton(e,a.obj,"ProductOutSideNo")).then(function(){e.getCtrl("BtnCopy").hide()})}):$.when(e.addSelect("Fund",jFun.getProductOutSideOptionsT4(b[0].AID))).then(function(){initButton(e,a.obj,"ProductOutSideNo")})}),e.addHandler("NextFlow",function(b){""!==GlbEnv.args.upcoming?(e.find(".jepun-upcoming").hide(),"Manager"===b.role?a(null,null,null,"1",0):a(null,null,null,"2",0)):a(null,null,null,"99",0)}),e.getCtrl("AID").on("change",function(){var a=$(this),b=jFun.getProductOutSideOptionsT4(a.val());b.reload=!0,e.addSelect("Fund",b)}),e.getCtrl("ProductOutSideNo").on("click",function(a){a.preventDefault();var c=$(this);b(c.val())}),e.getCtrl("QryFlow").on("click",function(a){a.preventDefault(),GlbAppModal.openModal("歷史流程","BackFlowDetail",{Type:8,Rno:e.getCtrl("ProductOutSideNo").val()})}),e.getCtrl("BtnCopy").on("click",function(a){if(a.preventDefault(),e.valid()){var b=e.getCtrl("Fund").val(),c=b.split("@@")[1],d=b.split("@@")[2];console.log(c+""+d),e.getCtrl("CID").val(c),e.getCtrl("FID").val(d),e.formXhrDataBus("BackProductOutSide/Copy")}}),e.getCtrl("BtnIns").on("click",function(a){if(a.preventDefault(),e.valid()){var b=e.getCtrl("Fund").val(),c=b.split("@@")[1],d=b.split("@@")[2];console.log(c+""+d),e.getCtrl("CID").val(c),e.getCtrl("FID").val(d),e.formXhrDataBus("BackProductOutSide/Ins")}}),e.getCtrl("BtnUpd").on("click",function(a){a.preventDefault();var b=e.formBeforeJSON(),c=e.getCtrl("Fund").val(),d=c.split("@@")[1],f=c.split("@@")[2];e.getCtrl("CID").val(d),e.getCtrl("FID").val(f),e.callDataBus("BackProductOutSide/Upd",{model:e.formToJSON(b,!1),Oldmodel:e.formBeforeJSON()})}),e.getCtrl("BtnDel").on("click",function(a){a.preventDefault(),e.callDataBus("BackProductOutSide/Del",{ProductOutSideNo:e.getCtrl("ProductOutSideNo").val(),NextType:"0",NextStatus:"7",Note:"",LogSN:e.getCtrl("LogSN").val()})}),e.getCtrl("BtnQry").on("click",function(b){b.preventDefault();var c=e.getCtrl("QryStartDate").val(),d=e.getCtrl("QryEndDate").val(),f=e.getCtrl("QryType").val(),g=e.getCtrl("QryStatus").val();a(c,d,f,g,0)}),e.getCtrl("BtnInsFile1,BtnInsFile2,BtnInsFile3,BtnInsFile4,BtnInsFile5").on("click",function(a){a.preventDefault();var b=$(this),d=b.getKeyVal(),f=e.getCtrl("InputFile_"+d).val();if(""===f)return void jCom.Alert("提醒","請選擇檔案!!");var g=e.getCtrl("ProductOutSideNo").val();e.getCtrl("FileKind").val(e.getCtrl("InputFile_"+d).attr("name"));return null===g||void 0===g?void jCom.Alert("提醒","請選一筆海外基金!!"):void e.formXhrDataBus("BackProductOutSide/Upload",function(){c(e.getCtrl("ProductOutSideNo").val(),d)})}),e.getCtrl("BtnDelFile1,BtnDelFile2,BtnDelFile3,BtnDelFile4,BtnDelFile5").on("click",function(a){a.preventDefault();var b=$(this),c=b.getKeyVal(),d=e.getCtrl("ProductOutSideFile"+c).val();return null===d||void 0===d?void jCom.Alert("提醒","請選一筆檔案!!"):(d=d.split("@@"),void e.callDataBus("BackProductOutSide/DelFile",{ProductOutSideNo:d[0],Num:d[1],LogSN:d[2],FileKind:d[3]}))}),e.getCtrl("ProductOutSideFile1,ProductOutSideFile2,ProductOutSideFile3,ProductOutSideFile4,ProductOutSideFile5").on("click",function(a){a.preventDefault();var b=$(this),c=b.val();if(null!==c){var d=c.split("@@"),e=$("#DefTargetForm").comm();e.formTarget("BackProductOutSide/Download","{'ProductOutSideNo':'"+d[0]+"','Num':'"+d[1]+"','FileKind':'"+d[3]+"'}")}}),e.getCtrl("BtnFlow").on("click",function(a){$(this);a.preventDefault();var b=(e.getCtrl("ProductOutSideFile1").val(),e.getCtrl("ProductOutSideFile2").val(),e.getCtrl("ProductOutSideFile3").val(),e.getCtrl("ProductOutSideFile4").val(),e.getCtrl("ProductOutSideFile5").val(),e.getCtrl("NextFlow").val().split("@@")),c={};return c.ProductOutSideNo=e.getCtrl("ProductOutSideNo").val(),c.NextType=b[0],c.NextStatus=b[1],c.Note="",c.EndDate=e.getCtrl("EndDate").val(),c.LogSN=e.getCtrl("LogSN").val(),"1"===b[0]&&""===e.getCtrl("EndDate").val()?void jCom.Alert("提醒","下架日必須填"):void e.callDataBus("BackProductOutSide/NextFlow",c)})});